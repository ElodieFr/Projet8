import mlflow
import mlflow.pyfunc
import pandas as pd
import streamlit as st
import os
import plotly.graph_objects as go

# DÃ©finition des chemins locaux
DATA_PATH = "data/"
MODEL_PATH = "models/model"

# VÃ©rification des fichiers nÃ©cessaires
def check_file_exists(file_path):
    if not os.path.exists(file_path):
        st.error(f"âš ï¸ Fichier introuvable : {file_path}")
        return False
    return True

# DÃ©finition des fonctions utilitaires
@st.cache_data()
def load_test_data():
    """Charge les donnÃ©es de test en local"""
    file_path = os.path.join(DATA_PATH, "application_test.csv")
    if check_file_exists(file_path):
        return pd.read_csv(file_path)
    return None

@st.cache_data()
def load_test_data_description():
    """Charge la description des donnÃ©es en local"""
    file_path = os.path.join(DATA_PATH, "HomeCredit_columns_description.csv")
    if check_file_exists(file_path):
        return pd.read_csv(file_path)
    return None

@st.cache_data()
def retrieve_feature_names():
    """Charge les noms des features en local"""
    file_path = os.path.join(DATA_PATH, "feature_names.txt")
    if check_file_exists(file_path):
        with open(file_path, "r") as f:
            return f.read().splitlines()
    return []

@st.cache_resource()
def load_model():
    """Charge le modÃ¨le MLflow en local"""
    if check_file_exists(MODEL_PATH):
        try:
            return mlflow.sklearn.load_model(MODEL_PATH)
        except Exception as e:
            st.error(f"âš ï¸ Erreur lors du chargement du modÃ¨le : {str(e)}")
            return None
    return None

# Chargement des donnÃ©es et du modÃ¨le
model = load_model()
feature_names = retrieve_feature_names()
customer_data = load_test_data()
customer_data_description = load_test_data_description()
optimal_threshold = 0.636364

# VÃ©rifier que les donnÃ©es et le modÃ¨le sont bien chargÃ©s avant de continuer
if customer_data is None or model is None:
    st.error("âš ï¸ Impossible de charger les donnÃ©es ou le modÃ¨le. VÃ©rifiez que tous les fichiers sont disponibles.")
    st.stop()  # ArrÃªte l'exÃ©cution de Streamlit

# Fonction de prÃ©diction
def make_prediction(input_data, model, optimal_threshold):
    """Effectue une prÃ©diction et renvoie la probabilitÃ© et l'Ã©tiquette"""
    input_df = pd.DataFrame([input_data])

    try:
        probability_class1 = model.predict_proba(input_df)[:, 1][0]
        prediction_label = "RefusÃ©" if probability_class1 >= optimal_threshold else "AcceptÃ©"
        return probability_class1, prediction_label
    except Exception as e:
        st.error(f"âš ï¸ Erreur lors de la prÃ©diction : {str(e)}")
        return None, None

# Fonction pour afficher une jauge avec Plotly
def gauge_chart(value, threshold=0.636364):
    fig = go.Figure(go.Indicator(
        mode="gauge+number",
        value=value,
        title={'text': "ProbabilitÃ© de dÃ©faut de paiement"},
        gauge={'axis': {'range': [0, 1]},
               'bar': {'color': "red" if value >= threshold else "green"},
               'steps': [
                   {'range': [0, threshold], 'color': "green"},
                   {'range': [threshold, 1], 'color': "red"}]}
    ))
    st.plotly_chart(fig)

# Interface Streamlit
def main():
    st.title("ğŸ“Š Credit Scoring Dashboard")

    st.header("ğŸ” SÃ©lection du client")
    sk_id_curr = st.number_input("Entrez un SK_ID_CURR:", 
                                 min_value=int(customer_data['SK_ID_CURR'].min()), 
                                 max_value=int(customer_data['SK_ID_CURR'].max()))

    if sk_id_curr in customer_data['SK_ID_CURR'].values:
        client_data = customer_data[customer_data['SK_ID_CURR'] == sk_id_curr].iloc[0].to_dict()
        st.write(f"ğŸ“‹ **Informations du client :**")
        st.json(client_data)

        # PrÃ©diction
        prob, label = make_prediction(client_data, model, optimal_threshold)

        if prob is not None:
            gauge_chart(prob, optimal_threshold)
            st.success(f"**RÃ©sultat de la prÃ©diction : {label}**")
        else:
            st.error("âš ï¸ Une erreur s'est produite lors de la prÃ©diction.")

    else:
        st.warning("âš ï¸ Client non trouvÃ©. Veuillez entrer un ID valide.")

if __name__ == "__main__":
    main()